!function(f){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=f();else if("function"==typeof define&&define.amd)define([],f);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).EDBCatalogBrain=f()}}(function(){return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n||e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){function _typeof(obj){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}function _possibleConstructorReturn(self,call){if(call&&("object"===_typeof(call)||"function"==typeof call))return call;if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function");subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Constructor}var PedanticCount=require("pedantic-count"),catMap=new Map,typeMap=new Map,dataMap=new Map,productInstances=new Map,bucketInstances=new Map,cartMap=new WeakMap,countersMap=new WeakMap,choiceMap=new WeakMap,shippingCosts=new Map;shippingCosts.set("furniture",{min:500,below:[65,150,250],above:[0,85,150]}),shippingCosts.set("small-furniture",{min:500,below:[18,25,28],above:[0,10,15]}),shippingCosts.set("accessories",{min:50,below:[15,15,15],above:[0,0,0]});var Cart=function(){function Cart(counts,cart){_classCallCheck(this,Cart),this.tokens=new Map,this.products=new Map,this.zone=null,this.discounts=[],this.userLevel=!1,countersMap.set(this,counts)}return _createClass(Cart,[{key:"setUserLevel",value:function(userLevel){return this.userLevel=userLevel}},{key:"addCoupon",value:function(percent){return this.discounts.push(percent)}},{key:"removeCoupon",value:function(percent){return this.discounts=this.discounts.filter(function(d){return d!==percent})}},{key:"setZone",value:function(string){return this.zone="zone-1"==string?0:"zone-2"==string?1:2,!0}},{key:"setZoneFromPostalCode",value:function(postcode){postcode=postcode.toUpperCase().trim();var zones_table={"zone-1":/^(H..|G1.|M..|K1.|T2.|T3.|T5.|T6.|V5.|V6.|C1A|R2.|R3.|E2.|E1.|E3.|B3.|S7.|S4.|A1.|J4.).+$/,"zone-3":/^(J|G|K|L|N|P|T|V|C|R|E|B|S|A|Y|X)0.+$/};if(!/^([a-zA-Z]\d[a-zA-Z]\s?\d[a-zA-Z]\d)$/.test(postcode))return this.setZone("zone-3");var found="zone-2";return Object.keys(zones_table).forEach(function(zone){zones_table[zone].test(postcode)&&(found=zone)}),this.setZone(found)}},{key:"hasProduct",value:function(id){return this.products.has("number"==typeof id?id:id.id)}},{key:"incrItemQuantity",value:function(cartItem,qty){return cartItem.updateChoices.forEach(function(choice,name){if("quantity"!==name){var option=choice.getOption(cartItem.choices[name]);option instanceof Set?option.forEach(function(o){o.incrCartCount(qty)}):option.incrCartCount(qty)}}),cartItem.choices.quantity+=qty,!0}},{key:"decrItemQuantity",value:function(cartItem,qty){return cartItem.updateChoices.forEach(function(choice,name){if("quantity"!==name){var option=choice.getOption(cartItem.choices[name]);option instanceof Set?option.forEach(function(o){o.decrCartCount(qty)}):option.decrCartCount(qty)}}),cartItem.choices.quantity-=qty,!0}},{key:"addItem",value:function(product){var it=this,selections=Object.assign({},product.selections),id=product.id,qty=selections.quantity;delete selections.quantity;var data={id:id,choices:selections,unitPrice:product.currentPrice},token=JSON.stringify(data);Object.assign(data.choices,{quantity:0});var cartItem=Object.assign(data,{token:token,choices:data.choices,shippingClass:product.shippingClass,updateChoices:product.choices,incr:function(qty){return!!it.incrItemQuantity(cartItem,qty)},decr:function(qty){return!!it.decrItemQuantity(cartItem,qty)},remove:function(qty){return!!it.removeItem(cartItem)}});return Object.defineProperties(cartItem,{minRegularPrice:{get:function(){var qty=0===this.choices.quantity?1:this.choices.quantity;return product.minRegularPrice*qty}},maxRegularPrice:{get:function(){var qty=0===this.choices.quantity?1:this.choices.quantity;return product.maxRegularPrice*qty}},minPrice:{get:function(){var qty=0===this.choices.quantity?1:this.choices.quantity;return product.minPrice*qty}},maxPrice:{get:function(){var qty=0===this.choices.quantity?1:this.choices.quantity;return product.maxPrice*qty}},itemCost:{get:function(){var qty=0===this.choices.quantity?1:this.choices.quantity;return this.unitPrice*qty}}}),this.products.has(id)||this.products.set(id,[]),this.products.get(id).push(token),this.tokens.set(token,cartItem),cartItem.incr(qty),this.tokens.get(token)}},{key:"removeItem",value:function(cartItem){cartItem.decr(cartItem.choices.quantity);var newTokens=this.products.get(cartItem.id).filter(function(t){return t!==cartItem.token});return 0==newTokens.length?this.products.delete(cartItem.id):this.products.set(cartItem.id,newTokens),this.tokens.delete(cartItem.token),!0}},{key:"reset",value:function(){var _this=this;return this.tokens.forEach(function(cartItem){_this.removeItem(cartItem)}),this.zone=null,!0}},{key:"discountCost",get:function(){var _this2=this;if(this.itemCost<=0)return 0;return[this.userLevel?"VIP"===this.userLevel?.05:"VVIP"===this.userLevel?.1:"VVVIP"===this.userLevel?.15:0:0].concat(this.discounts).reduce(function(t,d){return 0===d?t:t+_this2.itemCost*-d},0)}},{key:"shippingZone",get:function(){return null===this.zone?"n/a":"zone-".concat(this.zone+1)}},{key:"total",get:function(){var t=this.itemCost+this.taxCost+this.shippingCost+this.discountCost;return isNaN(t)?"n/a":t}},{key:"taxCost",get:function(){return null===this.zone?"n/a":0==this.itemCost?0:.15*this.itemCost}},{key:"shippingCost",get:function(){if(null===this.zone)return"n/a";var zone=this.zone,itemCost=this.itemCost,shippingClass="accessories";this.tokens.forEach(function(cartItem,token){var sclass=cartItem.shippingClass;"accessories"==shippingClass&&"small-furniture"==sclass&&(shippingClass=sclass),"small-furniture"!=shippingClass&&"accessories"!=shippingClass||"furniture"!=sclass||(shippingClass=sclass)});var rules=shippingCosts.get(shippingClass);return itemCost>=rules.min?rules.above[zone]:rules.below[zone]}},{key:"productCount",get:function(){return this.products.size}},{key:"itemCount",get:function(){return this.tokens.size}},{key:"itemCost",get:function(){var total=0;return this.tokens.forEach(function(cartItem,t){total+=cartItem.itemCost}),total}}]),Cart}(),Product=function(){function Product(id,counts,cart){var _this3=this;_classCallCheck(this,Product),this.id=id,cartMap.set(this,cart),countersMap.set(this,counts);var vids=dataMap.get(this.id).variations;vids&&vids.length&&vids.forEach(function(vid){productInstances.set(vid,new Product.Variation(vid,_this3,counts))}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,value:this.name}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,value:this.description}),Object.defineProperty(this,"image",{enumerable:!0,configurable:!0,value:this.image}),Object.defineProperty(this,"images",{enumerable:!0,configurable:!0,value:this.images}),Object.defineProperty(this,"type",{enumerable:!0,configurable:!0,value:this.type}),Object.defineProperty(this,"wireframe",{enumerable:!0,configurable:!0,value:this.wireframe}),Object.defineProperty(this,"anatomy",{enumerable:!0,configurable:!0,value:this.anatomy}),Object.defineProperty(this,"why_we_love",{enumerable:!0,configurable:!0,value:this.why_we_love})}return _createClass(Product,[{key:"hasBucket",value:function(name){return bucketInstances.has(name)}},{key:"getBucket",value:function(name){return bucketInstances.get(name)}},{key:"hasVariation",value:function(name){return!!~dataMap.get(this.id).variations.findIndex(function(vid){return productInstances.get(vid).name==name})}},{key:"getVariation",value:function(name){var idx=dataMap.get(this.id).variations.findIndex(function(vid){return productInstances.get(vid).name==name});if(~idx){var vid=dataMap.get(this.id).variations[idx];return productInstances.get(vid)}}},{key:"shippingClass",get:function(){return"furniture"}},{key:"name",get:function(){return dataMap.get(this.id).name}},{key:"description",get:function(){return dataMap.get(this.id).description}},{key:"why_we_love",get:function(){return{title:this.meta.why_we_love_title,content:this.meta.why_we_love_content}}},{key:"wireframe",get:function(){return this.meta.wireframe?{src:this.meta.wireframe.src,colors:this.meta.wireframe.colors||[]}:{src:null,colors:[]}}},{key:"anatomy",get:function(){var enfr={};return this.meta.anatomy_en?enfr.en={src:this.meta.anatomy_en.src,colors:this.meta.anatomy_en.colors||[]}:enfr.en={src:null,colors:[]},this.meta.anatomy_fr?enfr.fr={src:this.meta.anatomy_fr.src,colors:this.meta.anatomy_fr.colors||[]}:enfr.fr={src:null,colors:[]},enfr}},{key:"basePrice",get:function(){return this.meta.base_price||1*this.meta.base_price==0?parseInt(this.meta.base_price):null}},{key:"meta",get:function(){var meta_box=dataMap.get(this.id).meta_box;return meta_box?Object.keys(meta_box).reduce(function(keep,key){return/edb_/.test(key)?keep[key.replace(/edb_/,"")]=meta_box[key]:keep[key.replace(/^_/,"")]=meta_box[key],keep},{}):{}}},{key:"image",get:function(){var images=dataMap.get(this.id).images;return images.length?{src:images[0].src,colors:images[0].colors||[]}:{src:null,colors:[]}}},{key:"images",get:function(){var images=dataMap.get(this.id).images;return images.length?images.slice(1).map(function(img){return{src:img.src,colors:img.colors||[]}}):[]}},{key:"type",get:function(){return typeMap.get(this.id)}},{key:"minRegularPrice",get:function(){var choicePrice=new PedanticCount.LoggingCount(0);return this.choices&&this.choices.forEach(function(choice,name){"quantity"!==name&&choicePrice.incr(choice.minRegularPrice,"add ".concat(choice.name,"'s min regular price of $"))}),null!==this.basePrice&&choicePrice.incr(this.basePrice,"add the base unit price of $".concat(this.basePrice)),choicePrice}},{key:"maxRegularPrice",get:function(){var choicePrice=new PedanticCount.LoggingCount(0);return this.choices&&this.choices.forEach(function(choice,name){"quantity"!==name&&choicePrice.incr(choice.maxRegularPrice,"add ".concat(choice.name,"'s max regular price of $"))}),null!==this.basePrice&&choicePrice.incr(this.basePrice,"add the base unit price of $".concat(this.basePrice)),choicePrice}},{key:"minSalePrice",get:function(){var choicePrice=new PedanticCount.LoggingCount(0);return this.choices&&this.choices.forEach(function(choice,name){"quantity"!==name&&choicePrice.incr(choice.minSalePrice,"add ".concat(choice.name,"'s min sale price of $"))}),null!==this.basePrice&&choicePrice.incr(this.basePrice,"add the base unit price of $".concat(this.basePrice)),choicePrice}},{key:"maxSalePrice",get:function(){var choicePrice=new PedanticCount.LoggingCount(0);return this.choices&&this.choices.forEach(function(choice,name){"quantity"!==name&&choicePrice.incr(choice.maxSalePrice,"add ".concat(choice.name,"'s max sale price of $"))}),null!==this.basePrice&&choicePrice.incr(this.basePrice,"add the base unit price of $".concat(this.basePrice)),choicePrice}},{key:"minPrice",get:function(){return Math.min(this.minSalePrice,this.minRegularPrice)}},{key:"maxPrice",get:function(){return Math.max(this.maxSalePrice,this.maxRegularPrice)}},{key:"currentPrice",get:function(){var choicePrice=new PedanticCount.LoggingCount(0);return this.choices&&this.choices.forEach(function(choice,name){"quantity"!==name&&(null!==choice.selectedOption?choicePrice.incr(choice.selectedOption.price,"add ".concat(choice.name,"'s current price of $")):choicePrice.incr(choice.minPrice,"add ".concat(choice.name,"'s max of $")))}),null!==this.basePrice&&choicePrice.incr(this.basePrice,"add the base unit price of $".concat(this.basePrice)),choicePrice}}]),Product}();Product.Variation=function(){function _class(id,parent,counts){_classCallCheck(this,_class),this.id=id,this.parent=parent,countersMap.set(this,counts)}return _createClass(_class,[{key:"select",value:function(qty){return countersMap.get(this).incrCount("selectedCount",this.id,qty,"select a quantity for variation #".concat(this.id," of"))}},{key:"unselect",value:function(qty){return countersMap.get(this).decrCount("selectedCount",this.id,qty)}},{key:"incrCartCount",value:function(qty){return countersMap.get(this).incrCount("cartCount",this.id,qty,"added to cart a quantity for variation #".concat(this.id," of"))}},{key:"decrCartCount",value:function(qty){return countersMap.get(this).decrCount("cartCount",this.id,qty,"removed from cart a quantity for variation #".concat(this.id," of"))}},{key:"name",get:function(){var attr=dataMap.get(this.id).attributes,name=Object.keys(attr).reduce(function(found,k){if(found)return found;var a=attr[k];return/edb/.test(k)&&(found=a.replace(/^edb_/,"").replace(/_/g,"-")),found},!1);return name||"Unknown"}},{key:"regularPrice",get:function(){return parseFloat(dataMap.get(this.id).display_regular_price)}},{key:"salePrice",get:function(){var disp=dataMap.get(this.id).display_price;return disp<this.regularPrice?disp:null}},{key:"price",get:function(){return null===this.salePrice?this.regularPrice:this.salePrice}},{key:"selected",get:function(){return!!this.isSelected},set:function(bool){return this.isSelected&&this.unselect(this.selectedCount),this.isSelected=!!bool,!0}},{key:"stockCount",get:function(){if("bucket"==this.parent.type){return countersMap.get(this).getCount("stockCount",this.id)>0?"n/a":0}return countersMap.get(this).getCount("stockCount",this.id)}},{key:"cartCount",get:function(){return countersMap.get(this).getCount("cartCount",this.id)}},{key:"selectedCount",get:function(){return countersMap.get(this).getCount("selectedCount",this.id)}}]),_class}(),Product.Choice=function(){function _class2(attr,parent){_classCallCheck(this,_class2),this.name=attr.name,this.type=attr.variation?"variation":"quantity"==attr.name?"count":"bucket",this.options=new Map,this.selected=null,this.parent=parent,"variation"==this.type&&attr.options.reduce(function(opts,name){var value;return value=parent.hasVariation(name)?parent.getVariation(name):name,opts.set(name,value),opts},this.options),"bucket"==this.type&&attr.options.reduce(function(opts,name){var value;return value=parent.hasBucket(name)?parent.getBucket(name):name,opts.set(name,value),opts},this.options),"count"==this.type&&(this.options.set("min",0),this.options.set("step",1),this.options.set("max",100),this.selected=new PedanticCount.LoggingCount(0))}return _createClass(_class2,[{key:"getOption",value:function(name){return this.options.has(name)?this.options.get(name):null}},{key:"select",value:function(choice){var _this4=this;if("count"==this.type){if(isNaN(choice))throw new Error('Cannot select quantity of "'.concat(choice,'"'));this.selected.incr(choice,"increased the quantity choice by ".concat(choice)),this.parent.choices.forEach(function(parentChoice,name){parentChoice!==_this4&&parentChoice.selected&&parentChoice.options.get(parentChoice.selected).select(_this4.selected)})}else this.selected=null,this.options.forEach(function(option,name){name==choice?(_this4.selected=name,option.selected=!0):option.selected=!1});return!0}},{key:"unselect",value:function(choice){if("count"==this.type){if(isNaN(choice)&&arguments.length>0)throw new Error('Cannot unselect quantity of "'.concat(choice,'"'));this.selected.decr(choice,"decreased the quantity choice by ".concat(choice))}else{var current=this.selectedOption;current&&(current.selected=!1),this.selected=null}return!0}},{key:"minRegularPrice",get:function(){if("count"==this.type)return 0;var prices=[];return this.options.forEach(function(option,name){isNaN(option.regularPrice)?prices.push(0):prices.push(option.regularPrice)}),Math.min.apply(Math,prices)}},{key:"maxRegularPrice",get:function(){if("count"==this.type)return 0;var prices=[];return this.options.forEach(function(option,name){isNaN(option.regularPrice)?prices.push(0):prices.push(option.regularPrice)}),Math.max.apply(Math,prices)}},{key:"minSalePrice",get:function(){if("count"==this.type)return 0;var prices=[];return this.options.forEach(function(option,name){null===option.salePrice||isNaN(option.salePrice)?prices.push(isNaN(option.regularPrice)?0:option.regularPrice):prices.push(option.salePrice)}),Math.min.apply(Math,prices)}},{key:"maxSalePrice",get:function(){if("count"==this.type)return 0;var prices=[];return this.options.forEach(function(option,name){null===option.salePrice||isNaN(option.salePrice)?prices.push(isNaN(option.regularPrice)?0:option.regularPrice):prices.push(option.salePrice)}),Math.max.apply(Math,prices)}},{key:"minPrice",get:function(){return Math.min(this.minSalePrice,this.minRegularPrice)}},{key:"maxPrice",get:function(){return Math.max(this.maxSalePrice,this.maxRegularPrice)}},{key:"currentPrice",get:function(){if("count"==this.type)return 0;var selectedOption=this.selectedOption;return null===selectedOption?null:selectedOption.price}},{key:"selectedOption",get:function(){return"count"==this.type?this.selected:null===this.selected?null:this.getOption(this.selected)}}]),_class2}(),Product.CompositeChoice=function(){function _class3(parentChoice,parent){_classCallCheck(this,_class3),this.name=parentChoice.name,this.type=parentChoice.type,this.parent=parent,this.parentChoices=new Set}return _createClass(_class3,[{key:"getOption",value:function(name){return this.options.has(name)?this.options.get(name):null}},{key:"select",value:function(choice){return this.parentChoices.forEach(function(parentChoice){parentChoice.select(choice)}),!0}},{key:"unselect",value:function(choice){return this.parentChoices.forEach(function(parentChoice){parentChoice.unselect(choice)}),!0}},{key:"add",value:function(parentChoice){this.parentChoices.add(parentChoice)}},{key:"selected",get:function(){var selected=null;return"count"==this.type?(selected=[],this.parentChoices.forEach(function(parentChoice){selected.push(parentChoice.selected)}),Math.min.apply(Math,selected)):(this.parentChoices.forEach(function(parentChoice){null!==parentChoice.selected&&(selected=parentChoice.selected)}),selected)}},{key:"selectedOption",get:function(){return"count"==this.type?this.selected:null===this.selected?null:this.getOption(this.selected)}},{key:"minRegularPrice",get:function(){var total=new PedanticCount.LoggingCount(0);return this.parentChoices.forEach(function(parentChoice){total.incr(parentChoice.minRegularPrice,"add child product #".concat(parentChoice.parent.id,"'s min regular price of $"))}),total}},{key:"maxRegularPrice",get:function(){var total=new PedanticCount.LoggingCount(0);return this.parentChoices.forEach(function(parentChoice){total.incr(parentChoice.maxRegularPrice,"add child product #".concat(parentChoice.parent.id,"'s max regular price of $"))}),total}},{key:"minSalePrice",get:function(){var total=new PedanticCount.LoggingCount(0);return this.parentChoices.forEach(function(parentChoice){total.incr(parentChoice.minSalePrice,"add child product #".concat(parentChoice.parent.id,"'s min sale price of $"))}),total}},{key:"maxSalePrice",get:function(){var total=new PedanticCount.LoggingCount(0);return this.parentChoices.forEach(function(parentChoice){total.incr(parentChoice.maxSalePrice,"add child product #".concat(parentChoice.parent.id,"'s max sale price of $"))}),total}},{key:"options",get:function(){var options=new Map;return this.parentChoices.forEach(function(parentChoice){parentChoice.options.forEach(function(parentOption,name){options.has(name)||options.set(name,new Set),options.get(name).add(parentOption)})}),options}}]),_class3}();var BaseProduct=function(_Product){function BaseProduct(id,counts,cart){var _this5;return _classCallCheck(this,BaseProduct),_this5=_possibleConstructorReturn(this,(BaseProduct.__proto__||Object.getPrototypeOf(BaseProduct)).call(this,id,counts,cart)),Object.defineProperty(_this5,"selected",{enumerable:!0,configurable:!0,value:_this5.selections}),_this5}return _inherits(BaseProduct,Product),_createClass(BaseProduct,[{key:"select",value:function(){var options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.choices.forEach(function(choice,name){~Object.keys(options).indexOf(name)&&choice.select(options[name])}),!0}},{key:"unselect",value:function(){var options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.choices.forEach(function(choice,name){~Object.keys(options).indexOf(name)&&choice.unselect(options[name])}),!0}},{key:"reset",value:function(){var unsel=Object.assign({},this.selections,{quantity:this.choices.get("quantity").selected});return this.unselect(unsel),!0}},{key:"addToCart",value:function(){return 0===this.choices.get("quantity").selected?new Error("Cannot add to cart, quantity missing"):this.hasValidSelections?(cartMap.get(this).addItem(this),this.reset()):new Error("Cannot add to cart, selections are missing")}},{key:"variations",get:function(){return dataMap.get(this.id).variations.map(function(vid){return productInstances.get(vid)})}},{key:"choices",get:function(){var _this6=this;if(choiceMap.has(this))return choiceMap.get(this);var attrs=dataMap.get(this.id).attributes;if(!attrs)return null;var choices=new Map;return choices.set("quantity",new Product.Choice({name:"quantity"},this)),attrs.reduce(function(obj,attr){return obj.set(attr.name,new Product.Choice(attr,_this6)),obj},choices),choiceMap.set(this,choices),choices}},{key:"selections",get:function(){var _this7=this;return Array.from(this.choices.keys()).reduce(function(o,key){return o[key]=_this7.choices.get(key).selected,o},{})}},{key:"hasValidSelections",get:function(){var selections=this.selections;return Object.keys(selections).every(function(key){return"quantity"==key||null!==selections[key]})}},{key:"stockCount",get:function(){var _this8=this,selectedOptionStock=null,source=null;return this.choices.forEach(function(choice,name){if("quantity"!==name){var selectedOption=choice.selectedOption;if(selectedOption){if("n/a"==selectedOption.stockCount)return selectedOptionStock;selectedOptionStock=selectedOption.stockCount,source=selectedOption}}}),null===selectedOptionStock?this.variations.reduce(function(t,v){return t.incr(v.stockCount,"include product #".concat(_this8.id,"'s variation #").concat(v.id,"'s stockCount of")),t},new PedanticCount.LoggingCount(0)):selectedOptionStock}},{key:"cartCount",get:function(){var _this9=this;return this.selectedVariation?this.getVariation(this.selectedVariation).cartCount:this.variations.reduce(function(t,v){return t.incr(v.cartCount,"include product#".concat(_this9.id," variation#").concat(v.id," cartCount of")),t},new PedanticCount.LoggingCount(0))}},{key:"selectedCount",get:function(){var _this10=this;return this.selectedVariation?this.getVariation(this.selectedVariation).selectedCount:this.variations.reduce(function(t,v){return t.incr(v.selectedCount,"include product#".concat(_this10.id," variation#").concat(v.id,"'s selectedCount of")),t},new PedanticCount.LoggingCount(0))}}]),BaseProduct}(),CompositeProduct=function(_BaseProduct){function CompositeProduct(){return _classCallCheck(this,CompositeProduct),_possibleConstructorReturn(this,(CompositeProduct.__proto__||Object.getPrototypeOf(CompositeProduct)).apply(this,arguments))}return _inherits(CompositeProduct,BaseProduct),_createClass(CompositeProduct,[{key:"unselect",value:function(){var _this11=this,options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.choices.forEach(function(choice,name){if(~Object.keys(options).indexOf(name)){_this11.choices.get(name).parentChoices.forEach(function(choice){choice.unselect(options[name])})}}),!0}},{key:"parents",get:function(){var gids=dataMap.get(this.id).meta_box.edb_group_ids;return(gids=gids.split(",").map(function(s){return parseInt(s.trim())})).map(function(gid){return productInstances.get(gid)})}},{key:"choices",get:function(){var _this12=this;if(choiceMap.has(this))return choiceMap.get(this);var compositeChoices=new Map;return this.parents.reduce(function(comps,parent){return parent.choices.forEach(function(parentChoice,name){comps.has(name)||comps.set(name,new Product.CompositeChoice(parentChoice,_this12)),comps.get(name).add(parentChoice)}),comps},compositeChoices)}},{key:"stockCount",get:function(){var counts=[];return this.parents.forEach(function(parent){"n/a"!==parent.stockCount&&counts.push(parent.stockCount)}),Math.min.apply(Math,counts)}},{key:"cartCount",get:function(){return Math.min.apply(Math,this.parents.map(function(parent){return parent.cartCount}))}},{key:"selectedCount",get:function(){return this.parents.reduce(function(t,parent){return t+(parent.selectedCount?1:0)},0)/this.parents.length}},{key:"basePrice",get:function(){return this.parents.reduce(function(t,parent){return t+(null===parent.basePrice?0:parent.basePrice)},0)}},{key:"minRegularPrice",get:function(){return this.parents.reduce(function(t,parent){return t+parent.minRegularPrice},0)}},{key:"maxRegularPrice",get:function(){return this.parents.reduce(function(t,parent){return t+parent.maxRegularPrice},0)}},{key:"minSalePrice",get:function(){return this.parents.reduce(function(t,parent){return t+parent.minSalePrice},0)}},{key:"maxSalePrice",get:function(){return this.parents.reduce(function(t,parent){return t+parent.maxSalePrice},0)}},{key:"currentPrice",get:function(){var _this13=this;return this.parents.reduce(function(choicePrice,parent){return parent.choices&&parent.choices.forEach(function(choice,name){if("quantity"!==name){var selected=_this13.choices.get(choice.name).selected;if(null!==selected){var option=choice.getOption(selected);choicePrice.incr(option.price,"add ".concat(name,"'s current price of $"))}}}),null!==parent.basePrice&&choicePrice.incr(parent.basePrice,"add the base unit price of $".concat(parent.basePrice)),choicePrice},new PedanticCount.LoggingCount(0))}}]),CompositeProduct}(),BucketProduct=function(_BaseProduct2){function BucketProduct(id,counts){var _this14;return _classCallCheck(this,BucketProduct),_this14=_possibleConstructorReturn(this,(BucketProduct.__proto__||Object.getPrototypeOf(BucketProduct)).call(this,id,counts)),_this14.selectedVariation=null,_this14.variations.forEach(function(v){bucketInstances.set(v.name,v)}),_this14}return _inherits(BucketProduct,BaseProduct),BucketProduct}(),EDBCatalogBrain=function(){function EDBCatalogBrain(){_classCallCheck(this,EDBCatalogBrain),this.counts.createIndex("stockCount"),this.counts.createVirtual("cartCount",0),this.counts.createVirtual("selectedCount",0),this.counts.link("stockCount","selectedCount"),this.counts.link("stockCount","cartCount"),this.cart=new Cart(this.counts)}return _createClass(EDBCatalogBrain,[{key:"getProduct",value:function(id){var type=typeMap.get(id);if(productInstances.has(id))return productInstances.get(id);switch(type){case"normal":productInstances.set(id,new Product(id,this.counts,this.cart));break;case"base":productInstances.set(id,new BaseProduct(id,this.counts,this.cart));break;case"composite":productInstances.set(id,new CompositeProduct(id,this.counts,this.cart));break;case"bucket":productInstances.set(id,new BucketProduct(id,this.counts,this.cart))}return productInstances.get(id)}},{key:"importVariations",value:function(json){var _this15=this;json.variation_data.forEach(function(v){var id=v.variation_id;dataMap.set(id,v),_this15.counts.setCount("stockCount",id,v.stock)})}},{key:"importCategories",value:function(json){json.categories.forEach(function(cat){dataMap.set(cat.slug,cat),catMap.has(cat.slug)||catMap.set(cat.slug,new Set),catMap.get(cat.slug).add(json.id)})}},{key:"importTypes",value:function(json){return json.meta_box&&json.meta_box.edb_group_ids?(typeMap.set(json.id,"composite"),"composite"):json.meta_box&&json.meta_box.edb_bucket_slug?(typeMap.set(json.id,"bucket"),"bucket"):json.meta_box&&json.meta_box.edb_base_price&&""!=json.meta_box.edb_base_price?(typeMap.set(json.id,"base"),"base"):(typeMap.set(json.id,"normal"),"normal")}},{key:"import",value:function(json){var _this16=this;if(Array.isArray(json))return json.map(function(item){return _this16.import(item)});var type=this.importTypes(json);this.importCategories(json),json.variation_data&&this.importVariations(json),dataMap.set(json.id,json),"bucket"==type&&this.getProduct(json.id)}},{key:"counts",get:function(){return PedanticCount.CountIndex}},{key:"categories",get:function(){return Array.from(catMap.keys())}},{key:"catalog",get:function(){var _this17=this;return this.categories.reduce(function(mapped,cat){return mapped.set(cat,Array.from(catMap.get(cat).values()).reduce(function(map,id){return map.set(id,_this17.getProduct(id)),map},new Map)),mapped},new Map)}}]),EDBCatalogBrain}();module.exports=EDBCatalogBrain},{"pedantic-count":2}],2:[function(require,module,exports){(function(global){!function(f){if("object"==typeof exports&&void 0!==module)module.exports=f();else{("undefined"!=typeof window?window:void 0!==global?global:"undefined"!=typeof self?self:this).PedanticCount=f()}}(function(){return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n||e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){function _typeof(obj){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}function _possibleConstructorReturn(self,call){if(call&&("object"===_typeof(call)||"function"==typeof call))return call;if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}function _get(object,property,receiver){null===object&&(object=Function.prototype);var desc=Object.getOwnPropertyDescriptor(object,property);if(void 0===desc){var parent=Object.getPrototypeOf(object);return null===parent?void 0:_get(parent,property,receiver)}if("value"in desc)return desc.value;var getter=desc.get;if(void 0!==getter)return getter.call(receiver)}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function");subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Constructor}var histMap=new WeakMap,logMap=new WeakMap,histories=function(object){return histMap.has(object)||histMap.set(object,[]),histMap.get(object)},loglines=function(object){return logMap.has(object)||logMap.set(object,[]),logMap.get(object)},BaseCount=function(){function BaseCount(initial){_classCallCheck(this,BaseCount),isNaN(initial)?this.set(0):this.set(initial)}return _createClass(BaseCount,null,[{key:"__defineProperty",value:function(obj,name,instance,logging){if(Object.defineProperty(obj,name,{enumerable:!0,value:instance}),obj.__countProperties__||Object.defineProperty(obj,"__countProperties__",{enumerable:!1,writeable:!0,value:{}}),Object.defineProperty(obj.__countProperties__,name,{enumerable:!0,get:function(){return instance}}),Object.defineProperty(obj,name+"History",{get:function(){return instance.history}}),logging){Object.defineProperty(obj,name+"Log",{get:function(){return instance.log}}),Object.defineProperty(obj,name+"Explanation",{get:function(){return instance.explain().replace(/Explain a Count/g,"Explain a Count named "+name)}});var oldExplain=obj.explainCounts;obj.explainCounts=function(){var previous=oldExplain?oldExplain.call(obj):null,bunch=previous?[previous]:[];return Object.keys(obj.__countProperties__).forEach(function(name){bunch.push(obj[name+"Explanation"])}),bunch.join("\n")}}}},{key:"defineProperty",value:function(obj,name,init,strict,logging){var clazz=BaseCount;logging?clazz=LoggingCount:strict&&(clazz=StrictCount);var instance=new clazz(init);return"function"==typeof Object.getPrototypeOf(obj)?BaseCount.__defineProperty(obj.prototype,name,instance,logging):BaseCount.__defineProperty(obj,name,instance,logging),obj}}]),_createClass(BaseCount,[{key:"valueOf",value:function(){return Number(histories(this).reduce(function(t,n){return t+n},0))}},{key:"get",value:function(){return 1*this}},{key:"set",value:function(v){var _this=this;return isNaN(v)?this.valueOf:(void 0!==v.history?v.history.forEach(function(v){_this.set(v)}):histories(this).push(v),this.valueOf)}},{key:"incr",value:function(n){return isNaN(n)&&(n=0),n<0&&(n=Math.abs(n)),this.set(n)}},{key:"decr",value:function(n){return isNaN(n)&&(n=0),n<0&&(n=Math.abs(n)),this.set(-1*n)}},{key:"reset",value:function(){var h=histories(this),first=h.shift();return h.splice(0,h.length),h.push(first),this.get()}},{key:"history",get:function(){return Array.from(histories(this))}},{key:"length",get:function(){return histories(this).length}}]),BaseCount}(),StrictCount=function(_BaseCount){function StrictCount(initial){if(_classCallCheck(this,StrictCount),isNaN(initial))throw new ReferenceError("Cannot initialize without numeric value");return _possibleConstructorReturn(this,(StrictCount.__proto__||Object.getPrototypeOf(StrictCount)).call(this,initial))}return _inherits(StrictCount,BaseCount),_createClass(StrictCount,[{key:"incr",value:function(n){if(isNaN(n))throw new ReferenceError("Cannot set non-numeric value");if(n<0)throw new ReferenceError("Cannot increment by negative value");return _get(StrictCount.prototype.__proto__||Object.getPrototypeOf(StrictCount.prototype),"incr",this).call(this,n)}},{key:"decr",value:function(n){if(isNaN(n))throw new ReferenceError("Cannot set non-numeric value");if(n<0)throw new ReferenceError("Cannot decrement by negative value");return _get(StrictCount.prototype.__proto__||Object.getPrototypeOf(StrictCount.prototype),"decr",this).call(this,n)}},{key:"set",value:function(v){if(isNaN(v))throw new ReferenceError("Cannot set non-numeric value");return _get(StrictCount.prototype.__proto__||Object.getPrototypeOf(StrictCount.prototype),"set",this).call(this,v)}}]),StrictCount}(),LoggingCount=function(_StrictCount){function LoggingCount(){return _classCallCheck(this,LoggingCount),_possibleConstructorReturn(this,(LoggingCount.__proto__||Object.getPrototypeOf(LoggingCount)).apply(this,arguments))}return _inherits(LoggingCount,StrictCount),_createClass(LoggingCount,[{key:"__defaultMessage",value:function(v,message){return[1===this.length?"initialize to":message||(v<0?"decrement by":"increment by"),Math.abs(v)].join(" ")}},{key:"set",value:function(v,message,fn){var _this2=this,result=_get(LoggingCount.prototype.__proto__||Object.getPrototypeOf(LoggingCount.prototype),"set",this).call(this,v);return message=this.__defaultMessage(v,message),void 0!==v.log?v.log.forEach(function(l,i){loglines(_this2).push(l)}):loglines(this).push(message),result}},{key:"incr",value:function(v,message){return this.set(v,message)}},{key:"decr",value:function(v,message){return this.set(-1*Math.abs(v),message)}},{key:"reset",value:function(){_get(LoggingCount.prototype.__proto__||Object.getPrototypeOf(LoggingCount.prototype),"reset",this).call(this);var initial=histories(this)[0],l=loglines(this),first=Array.from(l);return first.push("reset to "+initial),l.splice(0,l.length),l.push(first),this.get()}},{key:"explain",value:function(){var explained=function explanation(loglines,history,result,indent){result=result||["\nScenario: Explain a Count"],indent=indent||0,history.forEach(function(n,i){var log=loglines[i];if(Array.isArray(log)){var hist=new Array(log.length);return hist.fill(n),indent++,explanation(log,hist,result,indent)}result.push(/^initialize/.test(log)?"When I "+log:"And I "+log)});var space=new Array(indent).fill(" ").join("");return indent--,result.join("\n"+space+" ")}(loglines(this),histories(this));if(/Then the value equals \d/.test(explained))return explained;var total=this.get(),space=explained.split("\n").pop().replace(/^(\s+).+/,"$1");return explained+"\n".concat(space,"Then the value equals ").concat(total)}},{key:"log",get:function(){return Array.from(loglines(this))}}]),LoggingCount}(),indexMap=new Map,indexLinks=new Map,virtMap=new Map,CountIndex=function(){function CountIndex(name){_classCallCheck(this,CountIndex),this.name=name}return _createClass(CountIndex,null,[{key:"clear",value:function(){return indexMap.clear(),indexLinks.clear(),virtMap.clear(),!0}},{key:"clearIndex",value:function(name){return indexMap.delete(name),indexLinks.delete(name),virtMap.delete(name),!0}},{key:"createIndex",value:function(name){if(!this.map.has(name)){var idMap=new Map;idMap.set("ids",new Map),this.map.set(name,idMap)}return new CountIndex(name)}},{key:"createVirtual",value:function(name,defaultValue){if(!this.map.has(name)){var idMap=new Map;idMap.set("ids",new Map),this.map.set(name,idMap)}return virtMap.set(name,defaultValue),new CountIndex(name)}},{key:"index",value:function(name){return this.map.get(name)}},{key:"exists",value:function(name){return this.map.has(name)}},{key:"getIds",value:function(name){return this.exists(name)?Array.from(this.index(name).get("ids").keys()):[]}},{key:"getCounts",value:function(name){return this.exists(name)?Array.from(this.index(name).get("ids").values()):[]}},{key:"getTotal",value:function(name){return this.getCounts(name).reduce(function(t,c){return t+c},0)}},{key:"hasCount",value:function(name,id){return this.map.has(name)&&this.index(name).has("ids")&&this.index(name).get("ids").has(id)}},{key:"getCount",value:function(name,id){var _this3=this;if(!this.hasCount(name,id)){if(virtMap.has(name))return virtMap.get(name);throw new ReferenceError('No index for "#'+id+'" @ "'+name+'".')}var count=this.map.get(name).get("ids").get(id);if(!indexLinks.has(name))return count;return Array.from(indexLinks.get(name).values()).reduce(function(t,l){return t-_this3.getCount(l,id)},count)}},{key:"setCount",value:function(name,id,value){if(this.hasCount(name,id))throw new ReferenceError('Initial Count can only me set once for "#'+id+'" @ "'+name+'".');return this.map.get(name).get("ids").set(id,new LoggingCount(value))}},{key:"incrCount",value:function(name,id,n){if(this.hasCount(name,id))return this.map.get(name).get("ids").get(id).incr(n);if(virtMap.has(name))return this.setCount(name,id,virtMap.get(name)),this.incrCount(name,id,n);throw new ReferenceError('No count for id "'+id+'".')}},{key:"decrCount",value:function(name,id,n){if(this.hasCount(name,id))return this.map.get(name).get("ids").get(id).decr(n);if(virtMap.has(name))return this.setCount(name,id,virtMap.get(name)),this.decrCount(name,id,n);throw new ReferenceError('No count for id "'+id+'".')}},{key:"resetCount",value:function(name,id){return!this.hasCount(name,id)||this.map.get(name).get("ids").get(id).reset()}},{key:"getHistory",value:function(name,id){if(this.hasCount(name,id))return this.map.get(name).get("ids").get(id).history;throw new ReferenceError('No history for id "'+id+'".')}},{key:"getLog",value:function(name,id){if(this.hasCount(name,id))return this.map.get(name).get("ids").get(id).log;throw new ReferenceError('No log for id "'+id+'".')}},{key:"explain",value:function(name,id){if(this.hasCount(name,id))return this.map.get(name).get("ids").get(id).explain().replace("Scenario: Explain a Count","Scenario: Explain "+name+" for the id "+id);throw new ReferenceError('No explanation for id "'+id+'".')}},{key:"link",value:function(a,b){return indexLinks.has(a)||indexLinks.set(a,new Set),indexLinks.get(a).add(b),!0}},{key:"map",get:function(){return indexMap}}]),_createClass(CountIndex,[{key:"set",value:function(id,initialCount){return CountIndex.setCount(this.name,id,initialCount)}},{key:"get",value:function(id){return CountIndex.getCount(this.name,id)}},{key:"incr",value:function(id,n){return CountIndex.incrCount(this.name,id,n)}},{key:"decr",value:function(id,n){return CountIndex.decrCount(this.name,id,n)}},{key:"history",value:function(id){return CountIndex.getHistory(this.name,id)}},{key:"log",value:function(id){return CountIndex.getLog(this.name,id)}},{key:"explain",value:function(id){return CountIndex.explain(this.name,id)}},{key:"link",value:function(name){return CountIndex.link(this.name,name),!0}},{key:"ids",get:function(){return CountIndex.getIds(this.name)}},{key:"counts",get:function(){return CountIndex.getCounts(this.name)}}]),CountIndex}();module.exports={CountIndex:CountIndex,Count:BaseCount,StrictCount:StrictCount,LoggingCount:LoggingCount}},{}]},{},[1])(1)})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}]},{},[1])(1)});